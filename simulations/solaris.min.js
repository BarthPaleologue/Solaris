import{Astre}from"./astre.js";import{isDefined,rand}from"./tools.js";export class Solaris{constructor(engine,quality="high"){this.SCENE_SIZE=5e5,this.fulfilledTasks=0,this.astres=[],this.powerTime=3,this.clock=0,this.currentDay=1,this.currentMonth=1,this.currentYear=2020,this.targetCameras=[],this.freeCameras=[],this.transitionSpeedFactor=.3,this.precisionFactor=5,this.zooming=!1,this.changement=!1,this.targeting=!1,this.godraysList=[],this.areOrbitsEnabled=!1,this.areAsteroidsEnabled=!0,this.areGodraysEnabled=!0,this.areLabelsEnabled=!0,this.quality=quality,this.engine=engine,this.canvas=engine.getRenderingCanvas(),window.addEventListener("wheel",()=>this.zooming=!1),window.addEventListener("mousemove",()=>this.targeting=!1),BABYLON.ArcRotateCamera.prototype.targetNode=void 0}loadConfiguration(path){let xmlhttp=new XMLHttpRequest;xmlhttp.open("GET",path,!1),xmlhttp.overrideMimeType&&xmlhttp.overrideMimeType("application/json"),xmlhttp.send();let data=200==xmlhttp.status?JSON.parse(xmlhttp.responseText):{F:"ERROR"};this.diameterScalingFactor=data.diameterScalingFactor,this.distanceScalingFactor=data.distanceScalingFactor,this.firstTarget=data.firstTarget,this.timeSpeedFactor=data.timeSpeedFactor,this.timeUnit=this.timeSpeedFactor,this.diametreConversionFactor=data.diametreConversionFactor,this.distanceConversionFactor=data.distanceConversionFactor,this.astresData=data.astres,this.beltsData=data.belts,this.freeCameraSpeed=Math.pow(.05,2)*this.distanceScalingFactor}initScene(){let scene=new BABYLON.Scene(this.engine);return scene.clearColor=new BABYLON.Color4(0,0,0,1),scene.onPointerObservable.add((pointerInfo,eventState)=>{let target=pointerInfo.pickInfo.pickedMesh;if("ringsOf"==target.id.substring(0,7)){let astreTarget=this.getAstreById(target.id.substring(7));this.goTo(astreTarget)}else if("atmosphereOf"==target.id.substring(0,12)){let astreTarget=this.getAstreById(target.id.substring(12));this.goTo(astreTarget)}else this.goTo(this.getAstreById(target.id))},BABYLON.PointerEventTypes.POINTERPICK),scene.executeWhenReady(()=>{let loadingCompleteEvent=new Event("loadingComplete");document.dispatchEvent(loadingCompleteEvent),this.goTo(this.currentTarget),this.engine.runRenderLoop(()=>this.scene.render())}),scene.beforeRender=()=>this.update(),this.scene=scene,this.scene}initAssetsManager(){let assetsManager=new BABYLON.AssetsManager(this.scene);return assetsManager.useDefaultLoadingScreen=!1,assetsManager.onTaskSuccess=()=>{this.fulfilledTasks+=1;let fulfilled=Math.round(this.fulfilledTasks/assetsManager.tasks.length*100),progressEvent=new CustomEvent("loadingProgress",{detail:fulfilled});document.dispatchEvent(progressEvent)},this.assetsManager=assetsManager,this.assetsManager}initUI(){return this.UI=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI"),this.UI}initPipeline(){return this.pipeline=new BABYLON.DefaultRenderingPipeline("pipeline",!1,this.scene,this.scene.cameras),this.pipeline.bloomEnabled=!0,this.pipeline.fxaa=new BABYLON.FxaaPostProcess("fxaa",1,null,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this.engine,!1),this.pipeline.fxaaEnabled=!1,this.pipeline.imageProcessing.contrast=1.2,this.pipeline}initAudio(path,autoplay=!0,loop=!0){return this.audio=new Audio(path),this.audio.autoplay=autoplay,this.audio.loop=loop,this.audio.load(),this.audio}initSkybox(){let skybox=BABYLON.Mesh.CreateBox("skyBox",1,this.scene);skybox.scaling=skybox.scaling.scale(this.SCENE_SIZE),skybox.infiniteDistance=!0,skybox.isPickable=!1;let skyboxMaterial=new BABYLON.StandardMaterial("skyBoxMat",this.scene);return skyboxMaterial.backFaceCulling=!1,skyboxMaterial.reflectionTexture=new BABYLON.CubeTexture("../data/skybox7/skybox",this.scene),skyboxMaterial.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE,skyboxMaterial.diffuseColor=BABYLON.Color3.Black(),skyboxMaterial.specularColor=BABYLON.Color3.Black(),skyboxMaterial.reflectionTexture.level=5,skybox.material=skyboxMaterial,skybox.material.freeze(),skybox}initKeyboard(){let map={};return document.addEventListener("keydown",e=>{map[e.keyCode]=!0;let camera=this.scene.activeCamera;if(camera instanceof BABYLON.FreeCamera){if(map[32]&&(camera.cameraDirection.y+=this.freeCameraSpeed/20,camera.cameraDirection.y+=this.freeCameraSpeed/20),map[16]&&(camera.cameraDirection.y-=this.freeCameraSpeed/20,camera.cameraDirection.y-=this.freeCameraSpeed/20),map[90]||map[87]){let dx=Math.sin(camera.rotation.y),dy=-Math.sin(camera.rotation.x),dz=Math.cos(camera.rotation.y);camera.cameraDirection.x+=dx*this.freeCameraSpeed,camera.cameraDirection.y+=dy*this.freeCameraSpeed,camera.cameraDirection.z+=dz*this.freeCameraSpeed}if(map[83]){let dx=Math.sin(camera.rotation.y),dy=Math.sin(camera.rotation.x),dz=Math.cos(camera.rotation.y);camera.cameraDirection.x-=dx*this.freeCameraSpeed,camera.cameraDirection.y+=dy*this.freeCameraSpeed,camera.cameraDirection.z-=dz*this.freeCameraSpeed}if(map[68]){let dx=Math.cos(camera.rotation.y),dz=Math.sin(camera.rotation.y);camera.cameraDirection.x+=dx*this.freeCameraSpeed,camera.cameraDirection.z-=dz*this.freeCameraSpeed}if(map[81]||map[65]){let dx=Math.cos(camera.rotation.y),dz=Math.sin(camera.rotation.y);camera.cameraDirection.x-=dx*this.freeCameraSpeed,camera.cameraDirection.z+=dz*this.freeCameraSpeed}}map[70]&&this.toggleFXAA(),map[71]&&this.toggleGodrays(),map[72]&&this.toggleAsteroidBelts(),map[73]&&document.getElementById("infos").classList.toggle("hiddenInfos"),map[75]&&document.getElementById("fps").classList.toggle("hiddenFPS"),map[77]&&this.toggleSound(),map[78]&&this.toggleLabels(),map[79]&&this.toggleOrbits(),map[80]&&this.takeScreenshot(),map[84]&&document.getElementById("dateSelectorContainer").classList.toggle("hiddenDateSelector"),map[67]&&(this.zooming=!0),map[122]&&this.canvas.requestFullscreen()}),document.addEventListener("keyup",e=>map[e.keyCode]=!1),map}initAstres(){for(let astreData of this.astresData)this.createAstre(astreData)}initBelts(){for(let beltData of this.beltsData)this.createBelt(beltData)}addCamera(name,type){let newCamera;return"target"==type?(newCamera=new BABYLON.ArcRotateCamera(name,.3,Math.PI/4,400*this.diameterScalingFactor,BABYLON.Vector3.Zero(),this.scene),newCamera.upperRadiusLimit=this.SCENE_SIZE/15*this.diameterScalingFactor,newCamera.upperBetaLimit=3.14,newCamera.targetNode=BABYLON.Mesh.CreatePlane(`${name}TargetNode`,1e-100,this.scene),this.targetCameras.push(newCamera)):"targetAnaglyph"==type?(newCamera=new BABYLON.AnaglyphArcRotateCamera(name,.3,Math.PI/4,400*this.diameterScalingFactor,BABYLON.Vector3.Zero(),.33,this.scene),newCamera.upperRadiusLimit=this.SCENE_SIZE/15*this.diameterScalingFactor,newCamera.upperBetaLimit=3.14,newCamera.targetNode=BABYLON.Mesh.CreatePlane(`${name}TargetNode`,1e-100,this.scene),this.targetCameras.push(newCamera)):"free"==type?(newCamera=new BABYLON.FreeCamera(name,new BABYLON.Vector3(500,0,0).scale(this.diameterScalingFactor),this.scene),this.freeCameras.push(newCamera)):"freeAnaglyph"==type?(newCamera=new BABYLON.AnaglyphFreeCamera(name,new BABYLON.Vector3(500,0,0).scale(this.diameterScalingFactor),.033,this.scene),this.freeCameras.push(newCamera)):"freeVR"==type&&(newCamera=new BABYLON.VRDeviceOrientationFreeCamera(name,new BABYLON.Vector3(500,0,0).scale(this.diameterScalingFactor),this.scene),this.freeCameras.push(newCamera)),newCamera.maxZ=this.SCENE_SIZE,newCamera}switchTo(newCamera){this.scene.activeCamera.detachControl(this.canvas),newCamera.attachControl(this.canvas),this.scene.activeCamera=newCamera,newCamera instanceof BABYLON.FreeCamera&&(document.getElementById("zqsd").classList.toggle("visibleZQSD"),setTimeout(()=>document.getElementById("zqsd").classList.toggle("visibleZQSD"),3e3))}getAstreById(id){for(let astre of this.astres)if(astre.id==id)return astre;console.error(`Could not find ${id} in astres`)}createAstre(astreData){let astre=new Astre(astreData,isDefined(astreData.parentId)?this.getAstreById(astreData.parentId):void 0,this.astres.length,this.quality,this.assetsManager,this.scene);astre.setDiameterScale(this.diameterScalingFactor),astre.setDistanceScale(this.distanceScalingFactor),this.astres.push(astre);let label=astre.addLabel(this.UI);if(astre.mesh.isPickable&&label.onPointerUpObservable.add(()=>this.goTo(astre)),astreData.godrays){let light=new BABYLON.PointLight(`lightOf${astre.id}`,BABYLON.Vector3.Zero(),this.scene);light.parent=astre.mesh;let godrays=new BABYLON.VolumetricLightScatteringPostProcess(`godraysOf${astre.id}`,1,this.scene.cameras[0],astre.mesh,75,BABYLON.Texture.BILINEAR_SAMPLINGMODE,this.engine,!1);godrays.exposure=isDefined(astreData.exposure)?astreData.exposure:.2,godrays.decay=.95;for(let camera of this.scene.cameras)camera.attachPostProcess(godrays);this.godraysList.push([astre.mesh,light,godrays]);for(let i in this.godraysList)this.godraysList[i][1].excludedMeshes.push(astre.mesh),light.excludedMeshes.push(this.godraysList[i][0])}astreData.id==this.firstTarget&&(this.currentTarget=astre);let listElm=document.createElement("li");listElm.setAttribute("id",astreData.id),listElm.setAttribute("class",isDefined(astreData.parentId)?"satellite":"planete"),listElm.innerHTML=`<img src="../data/icons/${astreData.icon}"/><p>${astreData.id}</p>`,document.getElementById("astra-list").appendChild(listElm),listElm.addEventListener("click",()=>this.goTo(astre))}createBelt(beltData){let asteroid=BABYLON.Mesh.CreateSphere("asteroid",1,1.5*this.diameterScalingFactor,this.scene),ceintureAsteroids=new BABYLON.SolidParticleSystem(beltData.id,this.scene,{updatable:!1});ceintureAsteroids.addShape(asteroid,beltData.nb,{positionFunction:(particle,i)=>{particle.position.x=rand(beltData.position.nearest,beltData.position.farthest)*Math.sin(2*Math.PI/beltData.nb*i),particle.position.y=rand(-1,1)*beltData.yDivergence,particle.position.z=rand(beltData.position.nearest,beltData.position.farthest)*Math.cos(2*Math.PI/beltData.nb*i),particle.position=particle.position.scale(this.distanceScalingFactor),particle.scale.x=2*Math.random()+.8,particle.scale.y=Math.random()+.8,particle.scale.z=2*Math.random()+.8,particle.scale=particle.scale.scale(beltData.size),particle.rotation.x=rand(0,6.28),particle.rotation.y=rand(0,6.28),particle.rotation.z=rand(0,6.28)},vertexFunction:(particle,vertex)=>{vertex.x*=Math.random()+1,vertex.y*=Math.random()+1,vertex.z*=Math.random()+1}});let mesh=ceintureAsteroids.buildMesh(),mat=new BABYLON.StandardMaterial("mat",this.scene);"diffuse"==beltData.textureType?mat.diffuseTexture=new BABYLON.Texture("../data/rock.jpg",this.scene):"emissive"==beltData.textureType&&(mat.emissiveTexture=new BABYLON.Texture("../data/rock.jpg",this.scene),mat.disableLighting=!0),mat.specularColor=BABYLON.Color3.Black(),mat.freeze(),mesh.material=mat,isDefined(beltData.parentId)&&(mesh.parent=this.scene.getMeshByID(beltData.parentId)),mesh.freezeNormals(),asteroid.dispose()}takeScreenshot(precision=1){BABYLON.Tools.CreateScreenshotUsingRenderTarget(this.engine,this.scene.activeCamera,{precision:precision})}toggleOrbits(){this.areOrbitsEnabled=!this.areOrbitsEnabled;for(let astre of this.astres)astre.orbitMesh.setEnabled(this.areOrbitsEnabled);let event=new CustomEvent("toggleOrbits");document.dispatchEvent(event)}toggleAsteroidBelts(){this.areAsteroidsEnabled=!this.areAsteroidsEnabled;for(let belt of this.beltsData)this.scene.getMeshByID(belt.id).setEnabled(this.areAsteroidsEnabled);let event=new CustomEvent("toggleAsteroidBelts");document.dispatchEvent(event)}toggleGodrays(){if(this.areGodraysEnabled=!this.areGodraysEnabled,this.areGodraysEnabled)for(let i in this.godraysList)for(let camera of this.scene.cameras)camera.attachPostProcess(this.godraysList[i][2]);else for(let i in this.godraysList)for(let camera of this.scene.cameras)camera.detachPostProcess(this.godraysList[i][2]);let event=new CustomEvent("toggleGodrays");document.dispatchEvent(event)}toggleLabels(){if(this.areLabelsEnabled=!this.areLabelsEnabled,this.areLabelsEnabled)for(let astre of this.astres)(astre.id!=this.currentTarget.id&&!isDefined(astre.parent)||isDefined(astre.parent)&&astre.parent==this.currentTarget.parent||astre.parent==this.currentTarget)&&this.UI.addControl(astre.label);else for(let astre of this.astres)this.UI.removeControl(astre.label);let event=new CustomEvent("toggleLabels");document.dispatchEvent(event)}toggleSound(){if(1==this.audio.volume)for(let i=0;i<100;i++)setTimeout(()=>this.audio.volume=1-i/100,20*i);else for(let i=0;i<100;i++)setTimeout(()=>this.audio.volume=i/100,20*i);let event=new CustomEvent("toggleSound");document.dispatchEvent(event)}toggleFXAA(){this.pipeline.fxaaEnabled=!this.pipeline.fxaaEnabled;let event=new CustomEvent("toggleFXAA");document.dispatchEvent(event)}timeJump(timeLeap){for(let astre of this.astres)astre.updateRotation(2*Math.PI*timeLeap),astre.updateOrbitalPosition(2*Math.PI*timeLeap)}goTo(newTarget){for(let camera of this.targetCameras)camera.targetNode.position=this.currentTarget.mesh.absolutePosition,camera.lowerRadiusLimit=0,camera.setTarget(camera.targetNode);if(this.currentTarget.orbitMesh.color=BABYLON.Color3.White(),this.UI.addControl(this.currentTarget.label),this.UI.removeControl(newTarget.label),newTarget.orbitMesh.color=BABYLON.Color3.Yellow(),this.areLabelsEnabled)for(let astre of this.astres)astre!=this.currentTarget&&!isDefined(astre.parent)||isDefined(astre.parent)&&astre.parent==this.currentTarget.parent||astre.parent==this.currentTarget?this.UI.addControl(astre.label):this.UI.removeControl(astre.label);let event=new CustomEvent("targetChange",{detail:newTarget.data});document.dispatchEvent(event),this.currentTarget=newTarget,this.destinationRadius=(2*newTarget.data.diametre+1)*this.diameterScalingFactor,this.zooming=!0,this.targeting=!0,this.changement=!0}endTravel(){this.changement=!1;for(let camera of this.targetCameras)camera.setTarget(this.currentTarget.mesh),camera.lowerRadiusLimit=this.currentTarget.data.diametre*this.diameterScalingFactor+1}update(){let tickEvent=new CustomEvent("tick",{detail:Math.round(this.engine.getFps())});document.dispatchEvent(tickEvent);for(let camera of this.targetCameras)camera.wheelPrecision=100*this.precisionFactor/camera.radius,camera.pinchPrecision=camera.wheelPrecision;if(this.changement){for(let camera of this.targetCameras)camera.targetNode.position=camera.targetNode.position.add(this.currentTarget.mesh.absolutePosition.subtract(camera.targetNode.position).scale(.1*this.transitionSpeedFactor)),this.targeting&&camera.setTarget(camera.targetNode);for(let camera of this.freeCameras)camera.position=camera.position.add(this.currentTarget.mesh.absolutePosition.subtract(camera.position).scale(.1*this.transitionSpeedFactor));this.scene.activeCamera instanceof BABYLON.ArcRotateCamera?BABYLON.Vector3.DistanceSquared(this.scene.activeCamera.target,this.currentTarget.mesh.absolutePosition)<.1&&(Math.abs(this.scene.activeCamera.radius-this.destinationRadius)<.1||!this.zooming)&&this.endTravel():BABYLON.Vector3.DistanceSquared(this.scene.activeCamera.position,this.currentTarget.mesh.absolutePosition)<Math.pow(this.destinationRadius,2)&&this.endTravel()}if(this.zooming)for(let camera of this.targetCameras)camera.radius-=(camera.radius-this.destinationRadius)*this.transitionSpeedFactor/10;for(let astre of this.astres)astre.updateRotation(this.changement?0:this.timeUnit),astre.updateOrbitalPosition(this.changement?0:this.timeUnit);if(this.clock+=this.changement?0:this.timeUnit,this.clock>=2*Math.PI){let nbDaysPerMonth;this.currentDay+=Math.floor(this.clock/Math.PI*2),this.clock=this.clock%Math.PI*2,nbDaysPerMonth=[1,3,5,7,8,10,12].includes(this.currentMonth)?31:2==this.currentMonth&&this.currentYear%4==0&&this.currentYear%100!=0&&this.currentYear%400==0?29:2==this.currentMonth?28:30,this.currentDay>nbDaysPerMonth&&(this.currentMonth+=Math.round(this.currentDay/nbDaysPerMonth),this.currentDay=1),this.currentMonth>12&&(this.currentYear+=Math.round(this.currentMonth/12),this.currentMonth=1);let dateEvent=new CustomEvent("dateChange",{detail:{day:this.currentDay,month:this.currentMonth,year:this.currentYear}});document.dispatchEvent(dateEvent)}}start(){"low"==this.quality&&this.toggleGodrays(),this.assetsManager.load()}}